#!/usr/bin/env ruby
# frozen_string_literal: true

require "fileutils"
require "securerandom"
require "tmpdir"

ENV["RAILS_ENV"] = "development"

db_path = nil
if ENV["DATABASE_URL"].nil?
  temp_dir = Dir.tmpdir
  db_name = "tachymeter_#{SecureRandom.hex(6)}.db"
  db_path = File.join(temp_dir, db_name)
  ENV["DATABASE_URL"] = "sqlite3:#{db_path}"
  puts "Using temporary database at: #{db_path}"
end

ENV["VERBOSE"] = "true"
ENV["TACHYMETER_DEBUG"] = "true"
ENV["BUNDLE_GEMFILE"] = File.expand_path("../Gemfile", __dir__)

require "bundler/setup"
require "tachymeter"

Tachymeter.application.configure_database
Tachymeter.application.create_db
Tachymeter.application.load_schema
Tachymeter.application.seed

port = ENV.fetch("PORT", "3000")
binding_ip = ENV.fetch("BINDING", "localhost")

puts "Starting development server at http://#{binding_ip}:#{port}"
puts "Press Ctrl-C to stop"

pid = spawn("bundle", "exec", "rails", "server", "-p", port, "-b", binding_ip)

begin
  Process.wait(pid)
rescue Interrupt
  puts "\nShutting down server..."
ensure
  if db_path && File.exist?(db_path)
    puts "Removing temporary database: #{db_path}"
    File.delete(db_path)
  end

  puts "Server stopped"
end
